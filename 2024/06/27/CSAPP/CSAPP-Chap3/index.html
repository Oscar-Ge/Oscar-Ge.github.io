<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  
  
  <title>CSAPP-Chap3 程序的机器级表示 | Oscar-Ge</title>
  
  <meta name="author" content="Oscar" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="C, CSAPP, X86-64" />
  
  <meta name="description" content="主要学习内容：x86汇编 程序编码编译代码：linux&gt; gcc -Og -o p p1.c p2.c-Og 指使用机器代码实际编译流程：首先， 预处理器扩展源代码，插入所有用巨nelude 命令指定的文件，并扩展所有用 #define 声明指定的宏。其次，编译器产生两个源文件的汇编代码，名字分别为 pl. p2.s 。接下来，汇器会将汇编代码转化成二进制目标代码文件 pl.a p2.o 目">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP-Chap3 程序的机器级表示">
<meta property="og:url" content="https://oscar-ge.github.io/2024/06/27/CSAPP/CSAPP-Chap3/index.html">
<meta property="og:site_name" content="Oscar-Ge">
<meta property="og:description" content="主要学习内容：x86汇编 程序编码编译代码：linux&gt; gcc -Og -o p p1.c p2.c-Og 指使用机器代码实际编译流程：首先， 预处理器扩展源代码，插入所有用巨nelude 命令指定的文件，并扩展所有用 #define 声明指定的宏。其次，编译器产生两个源文件的汇编代码，名字分别为 pl. p2.s 。接下来，汇器会将汇编代码转化成二进制目标代码文件 pl.a p2.o 目">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-06-27T15:17:49.000Z">
<meta property="article:modified_time" content="2024-07-08T12:53:28.770Z">
<meta property="article:author" content="Oscar">
<meta property="article:tag" content="C">
<meta property="article:tag" content="CSAPP">
<meta property="article:tag" content="X86-64">
<meta name="twitter:card" content="summary">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/hq_dark.webp');
      }
    
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                        <li>
                                            
                                                <a href="/">
                                            
                                                
                                                    <i class="fa fa-home"></i>
                                                
                                                首页
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a href="/archives/">
                                            
                                                
                                                    <i class="fa fa-file"></i>
                                                
                                                档案馆
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a href="/friends/">
                                            
                                                
                                                    <i class="fa fa-paw"></i>
                                                
                                                好伙伴
                                            </a>
                                            
                                        </li>
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">Oscar-Ge</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>Oscar-Ge</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://oscar-ge.github.io/2024/06/27/CSAPP/CSAPP-Chap3/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">CSAPP-Chap3 程序的机器级表示</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2024-06-27T15:17:49.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2024-06-27</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">Oscar</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            12.92K
                        
                        字
                    </li>
                
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1720443208770"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><p>主要学习内容：x86汇编</p>
<h1 id="程序编码"><a href="#程序编码" class="headerlink" title="程序编码"></a>程序编码</h1><p>编译代码：<br>linux&gt; gcc -Og -o p p1.c p2.c<br>-Og 指使用机器代码<br>实际编译流程：首先， 预处理器扩展源代码，插入所有用巨nelude 命令指定的文件，并扩展所有用 #define 声明指定的宏。<br>其次，编译器产生两个源文件的汇编代码，名字分别为 pl. p2.s 。<br>接下来，汇器会将汇编代码转化成二进制目标代码文件 pl.a p2.o 目标代码是机器代码的一种形式，它包含所有指令的二进制表示，但是还没有填入全局值的地址。<br>最后，链接器将两个目标代码文件与实现库函数（例如 printf) 的代码合并，并产生最终的可执行代码文件（由命令行指示符 -op 指定的）。可执行代码是我们要考虑的机器代码的第二种形式，也就是处理器执行的代码格式</p>
<h1 id="机器级代码"><a href="#机器级代码" class="headerlink" title="机器级代码"></a>机器级代码</h1><p>x86-64 的机器代码和原始的 代码差别非常大。一些通常对 语言程序员隐藏的处理器状态都是可见的：</p>
<ul>
<li>程序计数器（通常称为 “PC”, x86-64 中用％豆 表示）给出将要执行的下一条指令在内存中的地址。</li>
<li>整数寄存器(register)文件包含 16 个命名的位置，分别存储 64 位的值。这些寄存器可以存储地址（对应于 语言的指针）或整数数据。有的寄存器被用来记录某些重要的程序状态，而其他的寄存器用来保存临时数据，例如过程的参数和局部变量，以及函数的返回值。</li>
<li>条件码寄存器(codition codes)保存着最近执行的算术或逻辑指令的状态信息。它们用来实现控制或数据流中的条件变化，比如说用来实现 if while 语句。</li>
<li>一组向量寄存器可以存放一个或多个整数或浮点数值。</li>
</ul>
<h2 id="e-g"><a href="#e-g" class="headerlink" title="e.g."></a>e.g.</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">mult2</span><span class="params">(<span class="type">long</span>, <span class="type">long</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">multstore</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> *dest)</span> &#123;</span><br><span class="line">	<span class="type">long</span> t = mult2(x, y);</span><br><span class="line">	*dest = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>linux&gt; gcc -Og -S mstore.c</code>会产生汇编文件<code>mstore.s</code>，包括以下几行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sumstore:</span><br><span class="line">    pushq   %rbx</span><br><span class="line">    movq    %rbx, %rbx</span><br><span class="line">    call    plus</span><br><span class="line">    movq    %rax, (%rbx)</span><br><span class="line">    popq    %rbx</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>我们可以用objdump充当反汇编器汇编代码：<br><code>linux&gt; objdump -d mstore.o</code><br>生成实际可执行的代码需要对一组目标代码文件运行链接器，而这一组目标代码文件中必须含有一个 main 函数。假设在文件 main.c 中有下面这样的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">multstore</span><span class="params">(<span class="type">long</span>, <span class="type">long</span>, <span class="type">long</span>*)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">long</span> d;</span><br><span class="line">multstore(<span class="number">2</span>, <span class="number">3</span>, &amp;d);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;2 * 3 --&gt; %1d\n&quot;</span>, d);</span><br><span class="line"><span class="keyword">return</span> O;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="title function_">mult2</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b)</span> &#123;</span><br><span class="line"><span class="type">long</span> s= a* b;</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，我们用如下方法生成可执行文件 prog:<br><code>linux&gt; gcc -Og -o prog main.c mstore.c</code><br>再进行反编译：<br><code>linux&gt; objdump -d prog</code></p>
<h3 id="格式注解"><a href="#格式注解" class="headerlink" title="格式注解"></a>格式注解</h3><p>所有.开头的行都是指导汇编器和器和链接器工作的伪指令，暂时可以忽略。<br>我们的表述是 ATT格式的汇编代码，这是 GCC OBJDUMP 和其他一些我们使用的工具的默认格式。在其他intel 和微软的文档中可能有intel格式的代码。</p>
<h2 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h2><p>Intel 用术语”字 (word)” 表示 16 位数据类型。因此，称 32 位数为“双字 (double words)”, 64 位数为“四字 (quad words)”。下图是所有对应的汇编代码数字类型。<br>![[Pasted image 20240630141628.png]]<br>大多数 GCC 生成的汇编代码指令都有一个字符的后缀，表明操作数的大小。例如，数据传送指令有四个变种： movb( 传送字节）、 movw( 传送字）、 movl( 传送双字）和 movq( 传送四字）</p>
<h1 id="访问信息"><a href="#访问信息" class="headerlink" title="访问信息"></a>访问信息</h1><p>一个 x86-64 的中央处理单元 (CPU) 包含一组 16 个存储 64 位值的通用目的寄存器。这些寄存器用来存储整数数据和指针。<br>![[Pasted image 20240630142700.png]]<br>在常见的程序里不同的寄存器扮演不同的角色。其中最特别的是栈指针 %rsp, 用来指明运行时栈的结束位置。有些程序会明确地读写这个寄存器。</p>
<h3 id="操作数（operand）指示符"><a href="#操作数（operand）指示符" class="headerlink" title="操作数（operand）指示符"></a>操作数（operand）指示符</h3><ul>
<li>立即数 （immediate）表示常数值</li>
<li>寄存器（register） 表示寄存器内容的变量</li>
<li>内存引用M_b[Addr] 对存储在内存中从地址Addr开始的b个字节数的引用<br>有多种寻址方式表示对不同形式的内存引用。<br>Imm(rb, ri, s) 表示的是最常用的形式 这样的引用有四个组成部分：一个立即数偏移Imm, 一个基址寄存器 rb’ 个变址寄存器 r, 和一个比例因子 s, s这里 必须是1,2,4或者8。<br>![[Pasted image 20240630143715.png]]</li>
</ul>
<h3 id="数据传输命令"><a href="#数据传输命令" class="headerlink" title="数据传输命令"></a>数据传输命令</h3><h4 id="MOV"><a href="#MOV" class="headerlink" title="MOV"></a>MOV</h4><p>最简单形式的数据传送指令-MOV 类。这些指令把数据从源位置复制到目的位置，不做任何变化。 MOV 类由四条指令组成： movb movw movl，movq，操作数据大小分别为1,2,4,8字节。<br>对于 <code>movq</code> 指令来说，需要源操作数和目标操作数，源操作数可以是立即数、寄存器值或内存值的任意一种，但目标操作数只能是寄存器值或内存值。指令的具体格式可以这样写 <code>movq [Imm|Reg|Mem], [Reg|Mem]</code>，第一个是源操作数，第二个是目标操作数，例如：</p>
<ul>
<li><code>movq Imm, Reg</code> -&gt; <code>mov $0x5, %rax</code> -&gt; <code>temp = 0x5;</code></li>
<li><code>movq Imm, Mem</code> -&gt; <code>mov $0x5, (%rax)</code> -&gt; <code>*p = 0x5;</code></li>
<li><code>movq Reg, Reg</code> -&gt; <code>mov %rax, %rdx</code> -&gt; <code>temp2 = temp1;</code></li>
<li><code>movq Reg, Mem</code> -&gt; <code>mov %rax, (%rdx)</code> -&gt; <code>*p = temp;</code></li>
<li><code>movq Mem, Reg</code> -&gt; <code>mov (%rax), %rdx</code> -&gt; <code>temp = *p;</code><br>这里有一种情况是不存在的，没有 <code>movq Mem, Mem</code> 这个方式，也就是说，我们没有办法用一条指令完成内存间的数据交换。<br>括号的意思就是寻址，这也分两种情况：</li>
<li>普通模式，(R)，相当于 <code>Mem[Reg[R]]</code>，也就是说寄存器 R 指定内存地址，类似于 C 语言中的指针，语法为：<code>movq (%rcx), %rax</code> 也就是说以 %rcx 寄存器中存储的地址去内存里找对应的数据，存到寄存器 %rax 中</li>
<li>移位模式，D(R)，相当于 <code>Mem[Reg[R]+D]</code>，寄存器 R 给出起始的内存地址，然后 D 是偏移量，语法为：<code>movq 8(%rbp),%rdx</code> 也就是说以 %rbp 寄存器中存储的地址再加上 8 个偏移量去内存里找对应的数据，存到寄存器 %rdx 中<br>对于寻址来说，比较通用的格式是 <code>D(Rb, Ri, S)</code> -&gt; <code>Mem[Reg[Rb]+S*Reg[Ri]+D]</code>，其中：</li>
<li><code>D</code> - 常数偏移量</li>
<li><code>Rb</code> - 基寄存器</li>
<li><code>Ri</code> - 索引寄存器，不能是 %rsp</li>
<li><code>S</code> - 系数<br>除此之外，还有如下三种特殊情况</li>
<li><code>(Rb, Ri)</code> -&gt; <code>Mem[Reg[Rb]+Reg[Ri]]</code></li>
<li><code>D(Rb, Ri)</code> -&gt; <code>Mem[Reg[Rb]+Reg[Ri]+D]</code></li>
<li><code>(Rb, Ri, S)</code> -&gt; <code>Mem[Reg[Rb]+S*Reg[Ri]]</code></li>
</ul>
<h4 id="MOVZ-MOVS"><a href="#MOVZ-MOVS" class="headerlink" title="MOVZ, MOVS"></a>MOVZ, MOVS</h4><p>还有两类数据移动指令，在将较小的源值复制到较大的目的时使用。所有这些指令都把数据从源（在寄存器或内存中）复制到目的寄存器 MOVZ 类中的指令把目的中剩余的字节填充为 o, MOVS 类中的指令通过符号扩展来填充，把源操作的最高位进行复制。<br>![[Pasted image 20240630151512.png]]</p>
<h4 id="压入与弹出栈数据"><a href="#压入与弹出栈数据" class="headerlink" title="压入与弹出栈数据"></a>压入与弹出栈数据</h4><p>栈是一种数据结构，可以添加或者删除值，不过要遵循”后进先出＂的原则。通过 push 操作把数据压入栈中，通过 pop 操作删除数据；<br>![[Pasted image 20240630201837.png]]<br>将一个四字值压入栈中，首先要将栈指针减 8, 然后将值写到新的栈顶地址。所以，<code>pushq %rbp</code>就等价于两条指令</p>
<h3 id="算数和逻辑操作"><a href="#算数和逻辑操作" class="headerlink" title="算数和逻辑操作"></a>算数和逻辑操作</h3><p>大多数操作都分成了指令类，这些指令类有各种带不同大小操作数的变种（只有 leaq 没有其他大小的变种）。例如，指令类ADD 由四条加法指令组成： addb addw addl addq, 分别是字节加法、字加法、双字加法和四字加法。事实上，给出的每个指令类都有对这四种不同大小数据的指令。<br>![[Pasted image 20240630202200.png]]</p>
<h4 id="LEAQ"><a href="#LEAQ" class="headerlink" title="LEAQ"></a>LEAQ</h4><p>leaq是movq的变形：从内存读数据到寄存器，它还可以简洁地描述普通的算术操作。例如，如果寄存%rdx 的值为 x, 那么指令 leaq 7 (%rdx, %rdx , 4), %rax 将设置寄存器 %rax 的值为 5x+7。</p>
<h4 id="一元和二元操作"><a href="#一元和二元操作" class="headerlink" title="一元和二元操作"></a>一元和二元操作</h4><p>第二组中的操作是一元操作，只有一个操作数，既是源又是目的。这个操作数可以是一个寄存器，也可以是一个内存位置(类似C中的++，–计算符)<br>第三组是二元操作，其中，第二个操作数既是源又是目的。这种语法让人想起C语言中的赋值运算符，例如 x-&#x3D;y 。不过，要注意，源操作数是第一个，目的操作数是第二个。</p>
<h4 id="移位操作"><a href="#移位操作" class="headerlink" title="移位操作"></a>移位操作</h4><p>先给出移位量，然后第二项给出的是要移位的数。</p>
<h4 id="discussion"><a href="#discussion" class="headerlink" title="discussion"></a>discussion</h4><p>我们看到图 3-10 所示的大多数指令，既可以用千无符号运算，也可以用千补码运算。只有右移操作要求区分有符号和无符号数。这个特性使得补码运算成为实现有符号整数运算的一种比较好的方法的原因之一.</p>
<h4 id="特殊算数操作"><a href="#特殊算数操作" class="headerlink" title="特殊算数操作"></a>特殊算数操作</h4><p>x86-64指令集对 128 （16字节） 数的操作提供有限的支持。<br>![[Pasted image 20240630204649.png]]<br>此外， x86-64 指令集还提供 两条不同的“单操作数”乘法指令，以计算两个 64值的全 128 位乘积一个是无符号数乘法 (mulq), 而另一个是补码乘法 (imulq) 。这两条指令都要求一个参数必须在寄存器 rax 中，而另一个作为指令的源操作数给出。然后乘积存放在寄存器 %rdx( 64 位）和 rax( 64 位）中。虽然 imulq 这个名字可以用于两个不同的乘法操作，但是汇编器能够通过计算操作数的数目，分辨出想用哪条指令。</p>
<h2 id="控制"><a href="#控制" class="headerlink" title="控制"></a>控制</h2><p>C语言中的某些结构，比如条件语句、循环语句和分支语句，要求有条件的执行，根据数据测试的结果来决定操作执行的顺序。</p>
<h3 id="条件码"><a href="#条件码" class="headerlink" title="条件码"></a>条件码</h3><p>除了整数寄存器， CPU 还维护着一组单个位的条件码 (condition code) 寄存器，它们描述了最近的算术或逻辑操作的属性。<br>先来回顾一下 x86-64 处理器中不同的寄存器：<br>![[Pasted image 20240630210958.png]]<br>寄存器中存储着当前正在执行的程序的相关信息：</p>
<ul>
<li>临时数据存放在 (%rax, …)</li>
<li>运行时栈的地址存储在 (%rsp) 中</li>
<li>目前的代码控制点存储在 (%rip, …) 中</li>
<li>目前测试的状态放在 CF, ZF, SF, OF 中</li>
</ul>
<h3 id="条件代码与跳转"><a href="#条件代码与跳转" class="headerlink" title="条件代码与跳转"></a>条件代码与跳转</h3><p>最后的四个标识位（CF, ZF, SF, OF）就是用来辅助程序的流程控制的，意思是：</p>
<ul>
<li>CF: Carry Flag (针对无符号数) 进位标志</li>
<li>ZF: Zero Flag 零标志</li>
<li>SF: Sign Flag (针对有符号数) 符号标志，最近操作得到负数</li>
<li>OF: Overflow Flag (针对有符号数)溢出标志：补码溢出</li>
</ul>
<h4 id="访问条件码"><a href="#访问条件码" class="headerlink" title="访问条件码"></a>访问条件码</h4><p>常用的使用方法有三种： 1) 可以根据条件码的某种组合，将一个字节设置为 或者 1, 2) 可以条件跳转到程序的某个其他的部分， 3) 可以有条件地传送数据。<br>SET 指令；它们之间的区别就在于它们考虑的条件码的组合是什么，这些指令名字的不同后缀指明了它们所考虑的条件码的组合。这些指令的后缀表示不同的条件而不是操作数大小。<br>![[Pasted image 20240701094436.png]]</p>
<h4 id="跳转指令"><a href="#跳转指令" class="headerlink" title="跳转指令"></a>跳转指令</h4><p>跳转 (jump) 指令会导致执行切换到程序中一个全新的位置。在汇编代码中，这些跳转的目的地通常用一个标号(label) 指明。<br>![[Pasted image 20240701110933.png]]</p>
<h4 id="用条件控制来实现条件分支"><a href="#用条件控制来实现条件分支" class="headerlink" title="用条件控制来实现条件分支"></a>用条件控制来实现条件分支</h4><p>类似C语言<code>goto</code>代码<br>控制流：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">	t = test-expr;</span><br><span class="line">	if (!t)</span><br><span class="line">		goto false;</span><br><span class="line">	then-statement</span><br><span class="line">	goto done;</span><br><span class="line">false:</span><br><span class="line">	else-statement</span><br><span class="line">done:</span><br></pre></td></tr></table></figure>
<h4 id="用条件传送来实现条件分支"><a href="#用条件传送来实现条件分支" class="headerlink" title="用条件传送来实现条件分支"></a>用条件传送来实现条件分支</h4><p>处理器中更加高效<br>使用数据的条件转移。这种方法计算1个条件操作的两种结果，然后再根据条件是否满足从中选取一个。<br>原始C代码和基于条件传送的实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">absdiff</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">long</span> result;</span><br><span class="line">	<span class="keyword">if</span> (x &lt; y)</span><br><span class="line">		result = y - x;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		result = x - y;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">cmovdiff</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">long</span> rval = y-x;</span><br><span class="line">	<span class="type">long</span> eval = x-y;</span><br><span class="line">	<span class="type">long</span> ntest = x &gt;= y;</span><br><span class="line">	<span class="keyword">if</span> (ntest) rval = eval;</span><br><span class="line">	<span class="keyword">return</span> rval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>汇编代码实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">absdiff:</span><br><span class="line">	movq %rsi, %rax</span><br><span class="line">	subq %rdi, %rax rval = y - x</span><br><span class="line">	movq %rdi, %rdx</span><br><span class="line">	subq %rsi, %rdx eval = x - y</span><br><span class="line">	cmpq %rsi, %rdi Compare x:y</span><br><span class="line">	cmovge %rdx, %rax if &gt;= rval = eval</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<p>原因：处理器通过使用流水线 (pipelining) 来获得高性能，在流水线中，一条指令的处理要经过一系列的阶段，每个阶段执行所需操作的一小部分（例如，从内存取指令、确定指令类型、从内存读数据、执行算术运算、向 内存写数据，以及更新程序计数器） 这种方法通过重叠连续指令的步骤来获得高性能，例如，在取一条指令的同时，执行它前面一条指令的算术运算。<br>为了提高效率，采用分支预测的逻辑。错误的预测会带来严重的性能下降。<br>![[Pasted image 20240701112437.png]]<br>更加详细的理解：<br>考虑以下表达式：<br><code>v = test-expr ? then-expr : else-expr;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	if (! test-expr)</span><br><span class="line">		goto false;</span><br><span class="line">	v = then-expr;</span><br><span class="line">	goto done;</span><br><span class="line">false:</span><br><span class="line">	v = else-expr;</span><br><span class="line">done:</span><br></pre></td></tr></table></figure>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><p>用条件测试和跳转组合起来实现循环的效果</p>
<h4 id="do-while-循环"><a href="#do-while-循环" class="headerlink" title="do-while 循环"></a>do-while 循环</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">loop:</span><br><span class="line">	body-statement</span><br><span class="line">	t = test-expr;</span><br><span class="line">	if (t)</span><br><span class="line">		goto loop;</span><br></pre></td></tr></table></figure>
<h4 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">goto test;</span><br><span class="line">loop:</span><br><span class="line">	body-statement</span><br><span class="line">test:</span><br><span class="line">	t = test-expr;</span><br><span class="line">	if (t)</span><br><span class="line">		goto loop;</span><br></pre></td></tr></table></figure>
<p>如果优化等级更高：首先用条件分支，如果初始条件不成立就跳过循环，把代码变换为 do-while 循环。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">t = test-expr;</span><br><span class="line">if (!t)</span><br><span class="line">	goto done;</span><br><span class="line">do</span><br><span class="line">	body-statement</span><br><span class="line">	while (test-expr);</span><br><span class="line">done:</span><br></pre></td></tr></table></figure>
<p>for和while类似</p>
<h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><p>使用跳转表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">switch_eg</span> <span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> z)</span>&#123;</span><br><span class="line">	<span class="type">long</span> w = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">switch</span> (x) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			w = y*z;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			w = y/z;</span><br><span class="line">			<span class="comment">// fall through</span></span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">			w += z;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">		<span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">			w -= z;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			w = <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> w;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>伪C代码如下，数组 jt 包含7个表项，每个都是 个代码块的地址。这些位置由代码的标号定义，在 jt 的表项中由代码指针指明，由标号加上&amp;&amp;前缀组成。（回想运算符＆创建一个指向数据值的指针。在做这 扩展时， GCC 的作者 们创 造了一个新的运算符&amp;＆，这个运算 符创 个指向代码位置 的指 针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">switch_eg_impl</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> n, </span></span><br><span class="line"><span class="params">					<span class="type">long</span> *dest)</span> </span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Table of code pointers */</span> </span><br><span class="line">	<span class="type">static</span> <span class="type">void</span> *<span class="title function_">jt</span><span class="params">(<span class="number">7</span>] = &#123; </span></span><br><span class="line"><span class="params">		&amp;&amp;loc_A, &amp;&amp;loc_def, &amp;&amp;loc_B, </span></span><br><span class="line"><span class="params">		&amp;&amp;loc_C, &amp;&amp;loc_D, &amp;&amp;loc_def, </span></span><br><span class="line"><span class="params">		&amp;&amp;loc_D </span></span><br><span class="line"><span class="params">	&#125;;</span></span><br><span class="line"><span class="params">	<span class="type">unsigned</span> <span class="type">long</span> index = n - <span class="number">100</span>; </span></span><br><span class="line"><span class="params">	<span class="type">long</span> val; </span></span><br><span class="line"><span class="params">	</span></span><br><span class="line"><span class="params">	<span class="keyword">if</span> (index &gt; <span class="number">6</span>) </span></span><br><span class="line"><span class="params">	</span></span><br><span class="line"><span class="params">	<span class="keyword">goto</span> loc_def; </span></span><br><span class="line"><span class="params">	<span class="comment">/* Multiway branch +/ </span></span></span><br><span class="line"><span class="comment"><span class="params">	goto *jt [index] ; </span></span></span><br><span class="line"><span class="comment"><span class="params">	</span></span></span><br><span class="line"><span class="comment"><span class="params">	loc_A: /* Case 100 */</span> </span></span><br><span class="line"><span class="params">	val = x * <span class="number">13</span>; </span></span><br><span class="line"><span class="params">	<span class="keyword">goto</span> done; </span></span><br><span class="line"><span class="params">	loc_B:  <span class="comment">/* Case 102 */</span></span></span><br><span class="line"><span class="params">		x= x + <span class="number">10</span>; </span></span><br><span class="line"><span class="params">	<span class="comment">/* Fall through +*/</span> </span></span><br><span class="line"><span class="params">	</span></span><br><span class="line"><span class="params">	loc_c: <span class="comment">/* Case 103 */</span> </span></span><br><span class="line"><span class="params">		val =x + <span class="number">11</span>; </span></span><br><span class="line"><span class="params">		<span class="keyword">goto</span> done; | </span></span><br><span class="line"><span class="params">	loc_D:  <span class="comment">/* Cases 104, 106 */</span> <span class="string">&#x27; </span></span></span><br><span class="line"><span class="string"><span class="params">		val = x * x; | </span></span></span><br><span class="line"><span class="string"><span class="params">		goto done; </span></span></span><br><span class="line"><span class="string"><span class="params">	loc_def: /* Default case */ </span></span></span><br><span class="line"><span class="string"><span class="params">		val = 0; |! </span></span></span><br><span class="line"><span class="string"><span class="params">	done: </span></span></span><br><span class="line"><span class="string"><span class="params">	</span></span></span><br><span class="line"><span class="string"><span class="params">		*dest = val;</span></span></span><br><span class="line"><span class="string"><span class="params">&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>可能会类似如下汇编代码，这里 %rdi 是参数 x，%rsi 是参数 y，%rdx 是参数 z, %rax 是返回值:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">switch_eg:</span><br><span class="line">    movq    %rdx, %rcx</span><br><span class="line">    cmpq    $6, %rdi    # x:6</span><br><span class="line">    ja      .L8</span><br><span class="line">    jmp     *.L4(, %rdi, 8)</span><br><span class="line">.section    .rodata</span><br><span class="line">    .align 8</span><br><span class="line">.L4:</span><br><span class="line">    .quad   .L8 # x = 0</span><br><span class="line">    .quad   .L3 # x = 1</span><br><span class="line">    .quad   .L5 # x = 2</span><br><span class="line">    .quad   .L9 # x = 3</span><br><span class="line">    .quad   .L8 # x = 4</span><br><span class="line">    .quad   .L7 # x = 5</span><br><span class="line">    .quad   .L7 # x = 6</span><br></pre></td></tr></table></figure>
<p>通过上面的例子，我们可以大概了解处理 switch 语句的方式：大的 switch 语句会用跳转表，具体跳转时可能会用到决策树（if-elseif-elseif-else）</p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>一种封装代码的方式，用一组指定的参数和一个可选的返回值实现了某种功能。然后，可以在程序中不同的地方调用这个函数。设计良好的软件用过程作为抽象机制，隐藏某个行为的具体实现，同时又提供清晰简洁的接口定义，说明要计算的是哪些值，过程会对程序状态产生什么样的影响。</p>
<h3 id="运行时栈"><a href="#运行时栈" class="headerlink" title="运行时栈"></a>运行时栈</h3><p>在 x86-64 中，所谓的栈，实际上一块内存区域，这个区域的数据进出满足先进后出的原则。越新入栈的数据，地址越低，所以栈顶的地址是最小的。<br>![[Pasted image 20240702152615.png]]<br>可以用 pushq popq 指令将数据存入栈中或是从栈中取出。将栈指针减小一个适当的量可以为没有指定初始值的数据在栈上分配空间。类似地，可以通过增加栈指针来释放空间。</p>
<h4 id="转移控制"><a href="#转移控制" class="headerlink" title="转移控制"></a>转移控制</h4><p>函数 转移到函数 要简单地把程序计数器 (P 设置为 的代码的起始位。不过， 稍后从 返回的时候，处理器必须记录好它 要继续 的执行的代码位置。x86 -64 机器中，这个信息是用指 all 调用过程 来记录的。该指 会把地址 压入栈中，并将 PC 设置为 的起始地址， 压入的地址 被称为返回地址，是紧跟在 call 指令后面的那条指令的地址。对应的指令 ret 从栈中弹出地址 A, 并把 PC 设置为A。<br>![[Pasted image 20240702185426.png]]<br>example：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Beginning of function multstore </span><br><span class="line"></span><br><span class="line">0000000000400540 &lt;multstore&gt;: </span><br><span class="line">400540: 53 push %rbx </span><br><span class="line">400541: 48 89 d3 mov Yrdx,%rbx </span><br><span class="line"></span><br><span class="line">Return from function multstore </span><br><span class="line"></span><br><span class="line">40054d: c3 retq</span><br><span class="line"></span><br><span class="line">Call to multstore from main </span><br><span class="line">400563: e8 d8 ff ff ff callq 400540 &lt;multstore&gt; </span><br><span class="line">400568: 48 8b 54 24 08 mov 0x8 (%rsp) ,%rdx</span><br></pre></td></tr></table></figure>
<p>执行过程：<br>![[Pasted image 20240702185728.png]]</p>
<h4 id="数据传送"><a href="#数据传送" class="headerlink" title="数据传送"></a>数据传送</h4><p>x86-64 中，大部分过程间的数据传送是通过寄存器实现的 例如，我们已经看到无数的函数示例，参数在寄存器 rdi rsi 和其他寄存器中传递 。<br>x86-64 中，可以通过寄存楛最多传递 个整型（例如整数和指针）参数 。寄 存器的使用是有特殊顺序的，寄存器使用的名字取决千要传递的数据类型的大小。<br>![[Pasted image 20240702185917.png]]超出6个的部分就要通过栈来传递 。<br>![[Pasted image 20240702190257.png]]</p>
<h4 id="栈上的局部存储"><a href="#栈上的局部存储" class="headerlink" title="栈上的局部存储"></a>栈上的局部存储</h4><p>到目前为止我们看到的大多数过程示例都不需要 超出寄存器大小的本地存储区域。不过有些时候，局部数据必须存放在内存中，常见的情况包括：</p>
<ul>
<li>寄存器不足够存放所有的本地数据。</li>
<li>对一个局部变蜇使用地址运算符＇＆＇，因此必须能够为它产生一个地址</li>
<li>某些局部变量是数组或结构，因此必须能够通过数组或结构引用被访问到 。在 描述数组和结构分配时，我们会讨论这个问题。<br>运行时栈提供了一种简单的、在需要时分配、函数完成时释放局部存储的机制。<br>既然是利用栈来进行函数调用，自然而然就可以推广到递归的情况，而对于每个过程调用来说，都会在栈中分配一个帧 Frames。每一帧里需要包含：</li>
<li>返回信息</li>
<li>本地存储（如果需要）</li>
<li>临时空间（如果需要）<br>整一帧会在过程调用的时候进行空间分配，然后在返回时进行回收，在 x86-64&#x2F;Linux 中，栈帧的结构是固定的，当前的要执行的栈中包括：</li>
<li>Argument Build: 需要使用的参数</li>
<li>如果不能保存在寄存器中，会把一些本地变量放在这里</li>
<li>已保存的寄存器上下文</li>
<li>老的栈帧的指针（可选）<br>而调用者的栈帧则包括：</li>
<li>返回地址（因为 <code>call</code> 指令被压入栈的）</li>
<li>调用所需的参数<br>具体如下图所示：<br>![[Pasted image 20240702221145.png]]</li>
</ul>
<h4 id="递归过程"><a href="#递归过程" class="headerlink" title="递归过程"></a>递归过程</h4><p>递归就是一个栈的实现过程！<br>例子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">pcount_r</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (x == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> (x &amp; <span class="number">1</span>) + pcount_r(x &gt;&gt; <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的汇编代码为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pcount_r:</span><br><span class="line">    mov     $0, %eax</span><br><span class="line">    testq   %rdi, %rdi</span><br><span class="line">    je      .L6</span><br><span class="line">    push    %rbx</span><br><span class="line">    movq    %rdi, %rbx</span><br><span class="line">    andl    $1, %ebx</span><br><span class="line">    shrq    %rdi</span><br><span class="line">    call    pcount_r</span><br><span class="line">    addq    %rbx, %rax</span><br><span class="line">    popq    %rbx</span><br><span class="line">.L6:</span><br><span class="line">    rep; ret</span><br></pre></td></tr></table></figure>
<p>实际执行的过程中，会不停进行压栈，直到最后返回，所以递归本身就是一个隐式的栈实现，但是系统一般对于栈的深度有限制（每次一都需要保存当前栈帧的各种数据），所以一般来说会把递归转换成显式栈来进行处理以防溢出。</p>
<h2 id="数据分配与访问"><a href="#数据分配与访问" class="headerlink" title="数据分配与访问"></a>数据分配与访问</h2><p>回顾一下数据类型所占字节的大小<br>![[Pasted image 20240702221633.png]]<br>对于数组声明<code>T A[N];</code>会产生两个效果：</p>
<ul>
<li>内存中会分配一个L * N字节的连续区域，L为数据类型T的大小</li>
<li>引入标识符A，A可用于作为指向数组第一个元素的指针<br>对于数组访问<code>A[i]</code>，若<code>A</code>的地址存放于<code>%rdx</code>，<code>i</code>存放于<code>%rcx</code>则指令<code>movl (%rdx, %rcx, 4), %eax</code>能访问int类型数组第i个元素。</li>
</ul>
<h4 id="指针运算"><a href="#指针运算" class="headerlink" title="指针运算"></a>指针运算</h4><p>C语言允许对指针进行运算，而计算出来的值会根据该指针引用的数据类型的大小进行伸缩. 比如<code>p+i</code>就会自动成为<code>x_p + L * i</code>,L是p的数据类型。<br>单操作数操作符’&amp;’和<code>&#39;*&#39;</code>可以产生指针和间接引用指针.<br>例子如下图：<br>![[Pasted image 20240705170059.png]]<br>返回数组值的操作类型为 <code>int</code>, 因此涉及 字节操作（例如<code>movl</code>) 和寄存器（例如<code> %eax</code>) 。那些返回指针的操作类型为 <code>int *</code> , 因此涉及 字节操作（例如<code> leaq</code>) 和寄存器（例如 <code>%rax</code>) 。</p>
<h4 id="嵌套数组"><a href="#嵌套数组" class="headerlink" title="嵌套数组"></a>嵌套数组</h4><p>对于多维的数组，基本形式是 <code>T A[R][C]</code>，R 是行，C 是列，如果类型 T 占 K 个字节的话，那么数组所需要的内存是 <code>R*C*K</code> 字节。具体在内存里的排列方式如下：<br>![[Pasted image 20240705172143.png]]<br>数组元素在内存中按照行优先的顺序排列。</p>
<h4 id="定长数组，变长数组"><a href="#定长数组，变长数组" class="headerlink" title="定长数组，变长数组"></a>定长数组，变长数组</h4><p>看不太懂<br>一般的C语言数组都是定长数组（最好先define一个长度减少复用debug耗时），C99允许方括号内有表达式<br>应该的意思是GCC 能够识别出程序访问多维数组的元素的步长，然后通过指针或者数组步长的加法避免更多时钟周期的乘法的优化。</p>
<h4 id="异质的数据结构"><a href="#异质的数据结构" class="headerlink" title="异质的数据结构"></a>异质的数据结构</h4><h5 id="结构体-struct"><a href="#结构体-struct" class="headerlink" title="结构体 struct"></a>结构体 struct</h5><p>结构体是 C 语言中非常常用的一种机制，具体在内存中是如何存放的呢？<br>ex1:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rec</span>   </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">    <span class="type">int</span> a[<span class="number">4</span>];  </span><br><span class="line">    <span class="type">size_t</span> i;         </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rect</span> *<span class="title">next</span>;</span>  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>![[Pasted image 20240705173101.png]]<br>ex2: （非对齐）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S1</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="type">int</span> i[<span class="number">2</span>];</span><br><span class="line">    <span class="type">double</span> v;</span><br><span class="line">&#125; *p;</span><br></pre></td></tr></table></figure>
<p>![[Pasted image 20240705173147.png]]<br>文中讲“具体对齐的原则是，如果数据类型需要 K 个字节，那么地址都必须是 K 的倍数”——这只是windows的原则，<br>Linux中的对齐策略是“2字节数据类型的地址必须为2的倍数，较大的数据类型（int,double,float）的地址必须是4的倍数”<br>原因：内存访问是以4.8字节为单位，非对齐效率低下<br>对于一个结构体来说，所占据的内存空间必须是最大的类型所需字节的倍数，所以可能需要占据更多的空间，所以在创建结构体的时候先把打的数据类型放在前面可能是一种优化</p>
<h5 id="union-联合"><a href="#union-联合" class="headerlink" title="union 联合"></a>union 联合</h5><p>所有成员共享同一块内存空间。即使它们是不同类型，<code>union</code>的大小也是其最大成员的大小。<br>在任何时候只能存储一个成员的值。如果存储了新的值，旧的值将被覆盖。<br>Therefore, 对于类型 <code>union U3 *</code>的指针 <code>p, p-&gt; p-&gt; i[O] p-&gt;v</code>引用 的都是数据结构的起始位置.</p>
<h4 id="数据对齐"><a href="#数据对齐" class="headerlink" title="数据对齐"></a>数据对齐</h4><p>许多计算机系统对基本数据类型的合法地址做出了 些限制，要求某种类型对象的地址必须是某个值 K( 通常是1,2,4，8) 的倍数。</p>
<h2 id="在机器级程序中将控制与数据结合起来"><a href="#在机器级程序中将控制与数据结合起来" class="headerlink" title="在机器级程序中将控制与数据结合起来"></a>在机器级程序中将控制与数据结合起来</h2><h3 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h3><p>as said in [[61C-P1-C]]</p>
<h3 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h3><p>![[Pasted image 20240705204515.png]]<br>![[Pasted image 20240705204534.png]]</p>
<h4 id="内存越界引用和缓冲区溢出"><a href="#内存越界引用和缓冲区溢出" class="headerlink" title="内存越界引用和缓冲区溢出"></a>内存越界引用和缓冲区溢出</h4><p>C对于数组引用不进行任何边界检查，局部变量和状态信息都存储在栈中–对越界的数组元素的写操作会破坏存储在栈中的状态信息！<br>一种特别常见的状态破坏称为缓冲区溢出 (buffer overflow) 通常，在栈中分配某个字符数组来保存字符串，但是字符串的长度超出了为数组分配的空间<br>最好使用fgets函数，限制待读入的最大字节数<br>缓冲区溢出的一个更加致命的使用就是让程序执行它本来不愿意执行的函数。输入一个程序字符串，包含一些可执行代码的字节编码，称为攻击代码：</p>
<h4 id="对抗缓存区溢出攻击"><a href="#对抗缓存区溢出攻击" class="headerlink" title="对抗缓存区溢出攻击"></a>对抗缓存区溢出攻击</h4><ol>
<li>栈随机化（stack randomization）：使得栈的位置在程序每次运行时都有变化。Linux 系统中，栈随机化已经变成了标准行为 它是更大的一类技术中的一种，这类技术称为地址空间布局随机化 (Addr ess-Space Layout Randomization), 或者简称 ASLR。每次运行时程序的不同部分 ，包括程 序代码、库代码、栈、 全局变量和堆数据，都会被加载到内存的不同区域。<br>但是攻击者仍然可以反复地用不同的地址进行攻击，在实际攻击代码之前加一段很长的<code>nop</code>指令。猜中一个地址就会到达攻击代码（空操作雪橇）</li>
<li>栈破坏检测（stack corruption detection）：在栈帧中任何局部缓冲区和栈状态之间存一个随机产生的“金丝雀（canary）”值，规定为只读，检测其是否被修改</li>
<li>限制可执行的区域(limiting executable code regions)：栈可以被标记为不可执行区域</li>
</ol>
</div>
        </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://oscar-ge.github.io/2024/06/27/CSAPP/CSAPP-Chap3/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://oscar-ge.github.io/2024/06/27/CSAPP/CSAPP-Chap3/";
            const title         = "「CSAPP-Chap3 程序的机器级表示」";
            const excerpt       = `主要学习内容：x86汇编
程序编码编译代码：linux&gt; gcc -Og -o p p1.c p2.c-Og 指使用机器代码实际编译流程：首先， 预处理器扩展源代码，插入所有用巨nelude 命令指定的文件，并扩展所有用 #de...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/C/" rel="tag">C</a>, <a class="tag-none-link" href="/tags/CSAPP/" rel="tag">CSAPP</a>, <a class="tag-none-link" href="/tags/X86-64/" rel="tag">X86-64</a>
                </div>
                <div class="pull-date">
                    <time datetime="2024-07-08T12:53:28.770Z" itemprop="dateModified">最后编辑：2024-07-08</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" CSAPP-Chap2 信息的表示和处理" href="/2024/06/27/CSAPP/CSAPP-Chap2/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" CSAPP-Chap8-Exceptional Control Flow" href="/2024/07/09/CSAPP/CSAPP-Chap8/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
        <link rel="stylesheet" href="/vendors/gitalk@1.7.2/dist/gitalk.css"></script>
<div id="gitalk-container" class="post-comments lazy-load bg-image" style="padding-left:2rem; padding-right:2rem;"></div>
<script>
    var load_comm = () => {
        const init = () => {
            console.log('Gitalk loading...');
            const gitalk = new Gitalk(Object.assign({
                id: '/2024/06/27/CSAPP/CSAPP-Chap3/',
                path: '/2024/06/27/CSAPP/CSAPP-Chap3/'
            }, JSON.parse('{"clientID":"6b3b171cf9bd84026a37","clientSecret":"c29d8727a04cb5ea4d5c796fa065314ed2a11569","repo":"Oscar-Ge.github.io","owner":"Oscar-Ge","admin":["Oscar-Ge"],"distractionFreeMode":false}')));

            gitalk.render('gitalk-container');
        }
        if (typeof Gitalk === 'undefined') {
            const src = '/vendors/gitalk@1.7.2/dist/gitalk.min.js';
            $.getScript(src, init);
        } else {
            init();
        }
    };
</script>
<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://github.com/gitalk/gitalk">comments powered by Gitalk.</a></noscript>
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                47
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                10
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                46
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algs/">Algs</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CS-188/">CS 188</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CS-61A/">CS 61A</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CS-61B/">CS 61B</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CS-61C/">CS 61C</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CS106L/">CS106L</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CSAPP/">CSAPP</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Engineering-101/">Engineering 101</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linear-Algebra/">Linear Algebra</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NJU-PA/">NJU PA</a><span class="category-list-count">2</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/61B/" style="font-size: 0.8em;">61B</a> <a href="/tags/61C/" style="font-size: 0.72em;">61C</a> <a href="/tags/AI/" style="font-size: 0.6em;">AI</a> <a href="/tags/Algs/" style="font-size: 0.6em;">Algs</a> <a href="/tags/Assembly/" style="font-size: 0.6em;">Assembly</a> <a href="/tags/BST/" style="font-size: 0.6em;">BST</a> <a href="/tags/BTree/" style="font-size: 0.6em;">BTree</a> <a href="/tags/Basic/" style="font-size: 0.76em;">Basic</a> <a href="/tags/BasicC/" style="font-size: 0.68em;">BasicC</a> <a href="/tags/C/" style="font-size: 0.64em;">C</a> <a href="/tags/CPP/" style="font-size: 0.72em;">CPP</a> <a href="/tags/CPU/" style="font-size: 0.6em;">CPU</a> <a href="/tags/CS/" style="font-size: 0.76em;">CS</a> <a href="/tags/CS-61A/" style="font-size: 0.8em;">CS 61A</a> <a href="/tags/CS-61B/" style="font-size: 0.68em;">CS 61B</a> <a href="/tags/CSAPP/" style="font-size: 0.68em;">CSAPP</a> <a href="/tags/EE/" style="font-size: 0.6em;">EE</a> <a href="/tags/Exceptions/" style="font-size: 0.6em;">Exceptions</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2024/07/30/CS188/p1-search/"><i class="fa  fa-book"></i> p1-search</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/07/09/CSAPP/CSAPP-Chap8/"><i class="fa  fa-book"></i> CSAPP-Chap8-Exceptional Control Flow</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/06/27/CSAPP/CSAPP-Chap3/"><i class="fa  fa-book"></i> CSAPP-Chap3 程序的机器级表示</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/06/27/CSAPP/CSAPP-Chap2/"><i class="fa  fa-book"></i> CSAPP-Chap2 信息的表示和处理</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/06/25/CS61C/61C-P5-CPU/"><i class="fa  fa-book"></i> 61C-P5-CPU</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <!-- New links -->
                        
                            <li>
                                <a target="_blank" rel="nofollow" href="https://github.com/Oscar-Ge">
                                    
                                        <i class="fa fa-github"></i>
                                    
                                </a>
                            </li>
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2024 Oscar-Ge 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Oscar.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="2262932696"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>